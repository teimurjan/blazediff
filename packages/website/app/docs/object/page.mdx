# @blazediff/object

import { Callout } from "nextra/components";

Lightning-fast structural object comparison with detailed change tracking. High-performance algorithm optimized for real-world data structures.

## Installation

```sh npm2yarn
npm install @blazediff/object
```

## Key Features

- **High Performance** - Optimized algorithm with intelligent key lookup strategies
- **Precise Tracking** - Detailed path tracking for nested object modifications
- **Comprehensive Types** - Handles primitives, objects, arrays, dates, regex, and circular references
- **Memory Efficient** - Minimal overhead with consistent object shapes for V8 optimization
- **Cycle Detection** - Built-in circular reference handling with configurable detection
- **Rich Output** - Detailed difference objects with type, path, value, and oldValue information

## Quick Start

```javascript
import diff from '@blazediff/object';

const oldObj = {
  name: "John",
  age: 30,
  city: "NYC",
  skills: ["JavaScript", "TypeScript"]
};

const newObj = {
  name: "John",
  age: 31,
  city: "San Francisco",
  skills: ["JavaScript", "TypeScript", "Go"],
  active: true
};

const changes = diff(oldObj, newObj);
console.log(changes);
```

**Output:**
```json
[
  {
    "type": 2,
    "path": ["age"],
    "value": 31,
    "oldValue": 30
  },
  {
    "type": 2,
    "path": ["city"],
    "value": "San Francisco",
    "oldValue": "NYC"
  },
  {
    "type": 0,
    "path": ["skills", 2],
    "value": "Go",
    "oldValue": undefined
  },
  {
    "type": 0,
    "path": ["active"],
    "value": true,
    "oldValue": undefined
  }
]
```

## API Reference

### `diff(oldObj, newObj, options?)`

Compares two objects and returns an array of differences.

#### Parameters

| Parameter | Type     | Description                           |
| --------- | -------- | ------------------------------------- |
| `oldObj`  | `any`    | The original object to compare from   |
| `newObj`  | `any`    | The new object to compare to          |
| `options` | `object` | Configuration options (optional)      |

#### Options

| Option          | Type      | Default | Description                                    |
| --------------- | --------- | ------- | ---------------------------------------------- |
| `detectCycles`  | `boolean` | `true`  | Enable circular reference detection            |

#### Returns

Returns `Difference[]` - Array of difference objects with consistent structure:

```typescript
interface Difference {
  type: DifferenceType;
  path: (string | number)[];
  value: any;
  oldValue: any;
}
```

### Difference Types

<Callout type="info">
**Difference Types** are represented as numbers for optimal performance:
</Callout>

| Type | Name     | Description                            |
| ---- | -------- | -------------------------------------- |
| `0`  | `CREATE` | Property or array element was added    |
| `1`  | `REMOVE` | Property or array element was deleted  |
| `2`  | `CHANGE` | Property or array element was modified |

All difference objects maintain consistent shape with `type`, `path`, `value`, and `oldValue` fields for optimal V8 performance.

## Examples

### Basic Object Comparison

```javascript
import diff from '@blazediff/object';

// Property changes
const changes = diff(
  { a: 1, b: 2, c: 3 },
  { a: 1, b: 20, d: 4 }
);

// Returns:
// [
//   { type: 2, path: ['b'], value: 20, oldValue: 2 },
//   { type: 1, path: ['c'], value: undefined, oldValue: 3 },
//   { type: 0, path: ['d'], value: 4, oldValue: undefined }
// ]
```

### Nested Objects

```javascript
// Deep nested changes
const oldData = {
  user: {
    profile: {
      settings: { theme: 'dark', notifications: true }
    }
  }
};

const newData = {
  user: {
    profile: {
      settings: { theme: 'light', notifications: true }
    }
  }
};

const changes = diff(oldData, newData);
// [{ type: 2, path: ['user', 'profile', 'settings', 'theme'], value: 'light', oldValue: 'dark' }]
```

### Array Comparison

```javascript
// Array modifications
const changes = diff(
  { items: ['a', 'b', 'c'] },
  { items: ['a', 'x', 'c', 'd'] }
);

// Detects:
// - Element change at index 1: 'b' → 'x'
// - Element addition at index 3: 'd'
```

### Complex Data Types

```javascript
// Mixed data types
const oldObj = {
  date: new Date('2024-01-01'),
  regex: /test/g,
  nested: { count: 5 },
  list: [1, 2, 3]
};

const newObj = {
  date: new Date('2024-01-02'),
  regex: /test/i,
  nested: { count: 10 },
  list: [1, 2, 3, 4]
};

const changes = diff(oldObj, newObj);
// Handles Date objects, RegExp, nested objects, and arrays
```

### Circular Reference Handling

```javascript
// Objects with circular references
const obj1 = { name: 'A', data: { count: 1 } };
obj1.self = obj1;

const obj2 = { name: 'B', data: { count: 1 } };
obj2.self = obj2;

const changes = diff(obj1, obj2, { detectCycles: true });
// Safely detects name change without infinite recursion
```

## Configuration Options

### Cycle Detection

Control circular reference detection based on your data:

```javascript
// Enable for objects that might have circular references (default)
const changes = diff(obj1, obj2, { detectCycles: true });

// Disable for better performance when objects are guaranteed acyclic
const changes = diff(obj1, obj2, { detectCycles: false });
```

<Callout type="warning">
Disabling cycle detection improves performance but may cause infinite recursion with circular references.
</Callout>

## Performance Characteristics

The algorithm is optimized for real-world usage patterns:

### Smart Key Lookup
- **Small Objects (< 8 properties)**: Direct array operations without Set overhead
- **Large Objects (≥ 8 properties)**: Set-based key lookup for O(1) contains operations

### Early Optimizations
- **Reference Equality**: Immediate return for identical object references
- **Type Mismatches**: Fast detection of incompatible types (array vs object, primitives vs objects)
- **NaN Handling**: Proper NaN comparison without false positives

### Memory Efficiency
- **Consistent Shapes**: All difference objects have same structure for V8 optimization
- **Numeric Enums**: Faster comparisons than string constants
- **Minimal Allocations**: Reuses arrays and avoids unnecessary object creation

## Edge Cases Handled

<Callout type="success">
Comprehensive handling of JavaScript's quirks and edge cases:
</Callout>

- **Primitive Types**: Strings, numbers, booleans, null, undefined
- **Special Numbers**: NaN, Infinity, -Infinity, +0, -0
- **Rich Types**: Date objects, RegExp objects, String/Number objects
- **Sparse Arrays**: Arrays with holes (`[1, , 3]`)
- **Property Names**: Empty strings, unicode keys, special names
- **Circular References**: Safe traversal with cycle detection
- **Type Coercion**: Proper comparison without unexpected coercion
- **Large Datasets**: Efficient processing of objects with thousands of properties

## TypeScript Support

Full TypeScript definitions included:

```typescript
import diff, {
  Difference,
  DifferenceType,
  DifferenceCreate,
  DifferenceRemove,
  DifferenceChange
} from '@blazediff/object';

// Type-safe difference handling
const changes: Difference[] = diff(obj1, obj2);

// Type guards for specific difference types
const creates = changes.filter((c): c is DifferenceCreate => c.type === DifferenceType.CREATE);
const removes = changes.filter((c): c is DifferenceRemove => c.type === DifferenceType.REMOVE);
const changes_only = changes.filter((c): c is DifferenceChange => c.type === DifferenceType.CHANGE);
```

## Use Cases

### Data Validation
```javascript
// API response validation
const expected = { status: 'success', data: { count: 10 } };
const actual = await api.getData();
const issues = diff(expected, actual);

if (issues.length > 0) {
  console.log('API response validation failed:', issues);
}
```

### Configuration Management
```javascript
// Configuration drift detection
const baselineConfig = loadBaselineConfig();
const currentConfig = getCurrentConfig();
const drift = diff(baselineConfig, currentConfig);

drift.forEach(change => {
  reportConfigDrift(change.path.join('.'), change);
});
```

### State Management
```javascript
// Redux/state change tracking
const prevState = { user: { name: 'John', preferences: { theme: 'dark' } } };
const nextState = { user: { name: 'John', preferences: { theme: 'light' } } };

const stateChanges = diff(prevState, nextState);
// Track exactly what changed in your state
```

### Testing & Debugging
```javascript
// Unit test assertions
import { expect } from 'chai';

it('should update user profile correctly', () => {
  const before = { name: 'John', email: 'old@example.com' };
  const after = updateUser(before, { email: 'new@example.com' });

  const changes = diff(before, after);
  expect(changes).to.have.lengthOf(1);
  expect(changes[0].path).to.deep.equal(['email']);
});
```

## Links

- [GitHub Repository](https://github.com/teimurjan/blazediff)
- [NPM Package](https://www.npmjs.com/package/@blazediff/object)
- [Examples →](/examples/object-comparison)